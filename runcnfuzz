#!/bin/sh
die () {
  echo "*** runcnfuzz: $*" 1>&2
  exit 1
}
prg=""
while [ $# -gt 0 ]
do
  case $1 in
    -h) echo "usage: runcnfuzz <prg>";exit 0;;
    -*) die "invalid command line option";;
    *) prg="$*";break;;
  esac
done
[ x"$prg" = x ] && die "no program specified"
cnf=/tmp/runcnfuzz-$$.cnf
sol=/tmp/runcnfuzz-$$.sol
log=runcnfuzz-$$.log
rm -f $log
trap "rm -f $cnf $sol;exit 1" 2 9 15
i=0
echo "[runcnfuzz] running $prg"
echo "[runcnfuzz] logging $log"
while true
do
  rm -f $cnf
  cnfuzz $CNFUZZOPTIONS > $cnf
  seed=`head -1 $cnf|awk '{print $NF}'`
  head="`awk '/p cnf /{print $3, $4}' $cnf`"
  printf "%d% d% d% %d\r" "$i" "$seed" $head
  i=`expr $i + 1`
  rm -f $sol
  $prg $cnf 1>$sol 2>/dev/null
  case $? in
    10) 
      precochk $cnf $sol >/dev/null 2>/dev/null
      [ $? = 10 ] && continue
      ;;
    20)
      continue;;
  esac
  head="`awk '/p cnf /{print $3, $4}' $cnf`"
  echo "[runcnfuzz] bug-$seed $head"
  echo $seed >> $log
  red=red-$seed
  bug=bug-$seed
  mv $cnf $bug
  cnfdd $bug $red $prg 1>/dev/null 2>/dev/null
  head="`awk '/p cnf /{print $3, $4}' $red`"
  echo "[runcnfuzz] $red $head"
  rm -f $bug
done
